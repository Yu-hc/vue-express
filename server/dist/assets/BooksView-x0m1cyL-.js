import{a as m}from"./api-C3PXPV91.js";import{r as k}from"./recordService-DoMX_8kY.js";import{_ as g,c as n,a as s,w as y,g as b,v,i as B,n as I,j as D,F as S,r as C,k as p,T,l as x,f as l,t as d,b as f}from"./index-C1mtf5eF.js";const _="book";class u{static queryBook(e){return m.get(_,{params:{query:e}})}static allBooks(){return this.queryBook("*")}static postBook(e,c){return m.post(_,{key:e,value:c})}}const U={name:"BooksView",data(){return{booksData:"",booksKey:[],selectedBook:null,selectedBookIndex:null,page:1,containerWidth:0,currentUser:null,isLoggedIn:!1,searchQuery:""}},computed:{filteredBooks(){if(!this.booksData||!this.searchQuery.trim())return this.booksData;const t=this.searchQuery.toLowerCase().trim(),e={};return Object.keys(this.booksData).forEach(c=>{const i=this.booksData[c];[i.title,i.author,i.publisher,i.place].join(" ").toLowerCase().includes(t)&&(e[c]=i)}),e},gridColumns(){const t=this.containerWidth>768?250:200,e=this.containerWidth*.02,c=this.selectedBook?this.containerWidth*.7:this.containerWidth,i=Math.floor((c+e)/(t+e));return`repeat(${Math.max(2,Math.min(8,i))}, ${t}px)`}},watch:{"$route.query.bookId":{handler(t){t&&this.openBookDetails(t)},immediate:!0}},methods:{selectBook(t,e){this.selectedBook=t,console.log(this.selectedBook),this.selectedBookIndex=e},updateContainerWidth(){this.$refs.container&&(this.containerWidth=this.$refs.container.offsetWidth)},scrollToItem(t){const e=this.$refs[`bookItem-${t}`][0];e&&e.scrollIntoView({behavior:"smooth"})},closeDetails(){this.selectedBook=null},clearSearch(){this.searchQuery=""},scrollToSelectedItem(){this.scrollToItem(this.selectedBookIndex)},checkLoginStatus(){const t=localStorage.getItem("currentUser"),e=localStorage.getItem("isLoggedIn");t&&e==="true"&&(this.isLoggedIn=!0,this.currentUser=JSON.parse(t))},openBookDetails(t){if(this.booksData&&t){const e=Object.keys(this.booksData).find(c=>this.booksData[c].isbn===t);e!==void 0?(this.selectedBook=this.booksData[e],this.selectedBookIndex=parseInt(e),this.$nextTick(()=>{this.scrollToSelectedItem()})):console.warn("找不到指定的書籍:",t)}},async borrowBook(){if(!this.isLoggedIn||!this.currentUser){alert("請先登入才能借閱書籍"),this.$router.push("/join-us");return}if(this.selectedBook.borrow!=="0"){alert("此書已被借出");return}try{const e={bookId:this.selectedBook.isbn,userId:this.currentUser._id,userName:this.currentUser.name,bookTitle:this.selectedBook.title,borrowDate:new Date().toISOString().split("T")[0],returnDate:null,status:"borrowed"};await k.postRecord(JSON.stringify(e));var t={borrow:this.currentUser._id};await u.postBook(this.selectedBook._id,t),this.booksData=await u.allBooks(),this.booksKey=Object.keys(this.booksData),this.selectedBook.borrow=this.currentUser._id,alert("借閱成功！")}catch(e){console.error("借閱失敗:",e),alert("借閱失敗，請稍後再試")}},async returnBook(){if(!this.isLoggedIn||!this.currentUser){alert("請先登入才能歸還書籍");return}if(this.selectedBook.borrow!==this.currentUser._id){alert("您沒有借閱此書");return}try{const c=(await k.allRecords()).find(i=>i.bookId===this.selectedBook.isbn&&i.userId===this.currentUser._id&&i.status==="borrowed");c&&await k.updateRecord(c._id,{returnDate:new Date().toISOString().split("T")[0],status:"returned"});var t={borrow:"0"};await u.postBook(this.selectedBook._id,t),this.booksData=await u.allBooks(),this.booksKey=Object.keys(this.booksData),this.selectedBook.borrow="0",alert("歸還成功！")}catch(e){console.error("歸還失敗:",e),alert("歸還失敗，請稍後再試")}}},async mounted(){this.checkLoginStatus(),this.booksData=await u.allBooks(),this.booksKey=Object.keys(this.booksData),this.updateContainerWidth(),window.addEventListener("resize",this.updateContainerWidth),this.$route.query.bookId&&this.$nextTick(()=>{this.openBookDetails(this.$route.query.bookId)})},beforeUnmount(){window.removeEventListener("resize",this.updateContainerWidth)}},L={class:"handleScroll"},W={class:"search-container"},O={class:"grid-container",id:"split-container"},j={id:"bookshelf"},V={class:"books-container",ref:"container"},N=["onClick"],Q={class:"product-thumbnail"},q=["src"],E={class:"product-title"},R={class:"text"},z={key:0,class:"details-panel"},K={class:"details-content"},M=["src","alt"],A={key:0},F={key:1},J={key:0},G={key:2,class:"borrow-section"},H={class:"user-info"},P={class:"current-user"},X={key:2,class:"borrow-btn",disabled:""},Y={key:3,class:"login-prompt"};function Z(t,e,c,i,o,a){const w=x("router-link");return l(),n("div",L,[s("div",W,[y(s("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=r=>o.searchQuery=r),class:"search-input"},null,512),[[v,o.searchQuery]]),o.searchQuery?(l(),n("div",{key:0,class:"search-clear",onClick:e[1]||(e[1]=(...r)=>a.clearSearch&&a.clearSearch(...r))}," × ")):b("",!0)]),s("div",O,[s("section",j,[s("div",V,[s("div",{class:I(["grid-wrapper",{"with-details":o.selectedBook}]),ref:"gridWrapper"},[s("div",{class:"product-list",style:D({gridTemplateColumns:a.gridColumns})},[(l(!0),n(S,null,C(a.filteredBooks,(r,h)=>(l(),n("button",{class:"product-card",key:h,ref_for:!0,ref:`bookItem-${h}`,onClick:$=>a.selectBook(r,h)},[s("div",Q,[s("img",{loading:"lazy",src:r.cover},null,8,q)]),s("div",E,[s("div",R,d(r.title),1)])],8,N))),128))],4)],2),B(T,{name:"details-slide",onAfterEnter:e[5]||(e[5]=r=>a.scrollToSelectedItem()),onAfterLeave:e[6]||(e[6]=r=>a.scrollToSelectedItem())},{default:p(()=>[o.selectedBook?(l(),n("div",z,[s("div",K,[s("button",{onClick:e[2]||(e[2]=r=>a.closeDetails()),class:"close-btn"}," × "),s("img",{src:o.selectedBook.cover,alt:o.selectedBook.title,class:"large-image"},null,8,M),s("h2",null,d(o.selectedBook.title),1),s("p",null,"作者："+d(o.selectedBook.author),1),s("p",null,"出版社："+d(o.selectedBook.publisher),1),s("p",null,"位置："+d(o.selectedBook.place),1),o.selectedBook.borrow=="0"?(l(),n("p",A," 狀態：可借閱 ")):(l(),n("p",F,[e[7]||(e[7]=f(" 狀態：已借出 ")),o.isLoggedIn&&o.selectedBook.borrow===o.currentUser._id?(l(),n("span",J," （您已借閱） ")):b("",!0)])),o.isLoggedIn?(l(),n("div",G,[s("div",H,[s("p",P," 登入用戶："+d(o.currentUser.name),1)]),o.selectedBook.borrow=="0"?(l(),n("button",{key:0,onClick:e[3]||(e[3]=(...r)=>a.borrowBook&&a.borrowBook(...r)),class:"borrow-btn"}," 借閱 ")):o.selectedBook.borrow===o.currentUser._id?(l(),n("button",{key:1,onClick:e[4]||(e[4]=(...r)=>a.returnBook&&a.returnBook(...r)),class:"return-btn"}," 歸還 ")):(l(),n("button",X," 已借出 "))])):(l(),n("div",Y,[B(w,{to:"/join-us",class:"login-link"},{default:p(()=>e[8]||(e[8]=[f(" 前往登入 ")])),_:1})]))])])):b("",!0)]),_:1})],512)])])])}const se=g(U,[["render",Z]]);export{se as default};
